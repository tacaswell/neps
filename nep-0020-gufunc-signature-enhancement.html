
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>NEP 20 — Expansion of generalized universal function signatures &#8212; NumPy Enhancement Proposals</title>
    
  <link href="_static/css/theme.css" rel="stylesheet">
  <link href="_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/css/blank.css" />
    
  <link rel="preload" as="script" href="_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="NEP 22 — Duck typing for NumPy arrays – high level overview" href="nep-0022-ndarray-duck-typing-overview.html" />
    <link rel="prev" title="NEP 19 — Random number generator policy" href="nep-0019-rng-policy.html" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
<link rel="stylesheet" href="_static/numpy.css" type="text/css" />

    <!-- PR #17220: This is added via javascript in versionwarning.js  -->
    <!-- link rel="canonical" href="http://numpy.org/doc/stable/nep-0020-gufunc-signature-enhancement.html" / -->


  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    

<a class="navbar-brand" href="content.html">
  <img src="_static/numpylogo.svg" class="logo" alt="logo">
</a>


    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 current active nav-item">
 <a class="reference internal nav-link" href="index.html">
  Index
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="scope.html">
  The Scope of NumPy
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="roadmap.html">
  Current roadmap
 </a>
</li>

    
    <li class="nav-item">
        <a class="nav-link nav-external" href="https://github.com/numpy/numpy/issues?q=is%3Aopen+is%3Aissue+label%3A%2223+-+Wish+List%22">Wishlist<i class="fas fa-external-link-alt"></i></a>
    </li>
    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
        <li class="nav-item">
          <a class="nav-link" href="https://github.com/numpy/numpy" rel="noopener" target="_blank" title="GitHub">
            <span><i class="fab fa-github-square"></i></span>
            <label class="sr-only">GitHub</label>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="https://twitter.com/numpy_team" rel="noopener" target="_blank" title="Twitter">
            <span><i class="fab fa-twitter-square"></i></span>
            <label class="sr-only">Twitter</label>
          </a>
        </li>
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar"><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="scope.html">
   The Scope of NumPy
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="roadmap.html">
   Current roadmap
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference external" href="https://github.com/numpy/numpy/issues?q=is%3Aopen+is%3Aissue+label%3A%2223+-+Wish+List%22">
   Wish list
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="nep-0000.html">
   NEP 0 — Purpose and process
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="nep-template.html">
   NEP X — Template and instructions
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="nep-0034-infer-dtype-is-object.html">
   NEP 34 — Disallow inferring ``dtype=object`` from sequences
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="nep-0036-fair-play.html">
   NEP 36 — Fair play
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="nep-0038-SIMD-optimizations.html">
   NEP 38 — Using SIMD optimization instructions for performance
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="nep-0041-improved-dtype-support.html">
   NEP 41 — First step towards a new datatype system
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="nep-0042-new-dtypes.html">
   NEP 42 — New and extensible DTypes
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="nep-0044-restructuring-numpy-docs.html">
   NEP 44 — Restructuring the NumPy documentation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="nep-0045-c_style_guide.html">
   NEP 45 — C style guide
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="nep-0046-sponsorship-guidelines.html">
   NEP 46 — NumPy sponsorship guidelines
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="nep-0021-advanced-indexing.html">
   NEP 21 — Simplified and explicit advanced indexing
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="nep-0030-duck-array-protocol.html">
   NEP 30 — Duck typing for NumPy arrays - Implementation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="nep-0031-uarray.html">
   NEP 31 — Context-local and global overrides of the NumPy API
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="nep-0037-array-module.html">
   NEP 37 — A dispatch protocol for NumPy-like modules
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="nep-0043-extensible-ufuncs.html">
   NEP 43 — Enhancing the extensibility of UFuncs
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="nep-0047-array-api-standard.html">
   NEP 47 — Adopting the array API standard
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="nep-0048-spending-project-funds.html">
   NEP 48 — Spending NumPy project funds
  </a>
 </li>
</ul>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="nep-0001-npy-format.html">
   NEP 1 — A simple file format for NumPy arrays
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="nep-0005-generalized-ufuncs.html">
   NEP 5 — Generalized Universal Functions
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="nep-0007-datetime-proposal.html">
   NEP 7 — A proposal for implementing some date/time types in NumPy
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="nep-0010-new-iterator-ufunc.html">
   NEP 10 — Optimizing Iterator/UFunc performance
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="nep-0013-ufunc-overrides.html">
   NEP 13 — A mechanism for overriding Ufuncs
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="nep-0014-dropping-python2.7-proposal.html">
   NEP 14 — Plan for dropping Python 2.7 support
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="nep-0015-merge-multiarray-umath.html">
   NEP 15 — Merging multiarray and umath
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="nep-0018-array-function-protocol.html">
   NEP 18 — A dispatch mechanism for NumPy's high level array functions
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="nep-0019-rng-policy.html">
   NEP 19 — Random number generator policy
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   NEP 20 — Expansion of generalized universal function signatures
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="nep-0022-ndarray-duck-typing-overview.html">
   NEP 22 — Duck typing for NumPy arrays – high level overview
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="nep-0023-backwards-compatibility.html">
   NEP 23 — Backwards compatibility and deprecation policy
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="nep-0027-zero-rank-arrarys.html">
   NEP 27 — Zero rank arrays
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="nep-0028-website-redesign.html">
   NEP 28 — numpy.org website redesign
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="nep-0029-deprecation_policy.html">
   NEP 29 — Recommend Python and NumPy version support as a community policy standard
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="nep-0032-remove-financial-functions.html">
   NEP 32 — Remove the financial functions from NumPy
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="nep-0035-array-creation-dispatch-with-array-function.html">
   NEP 35 — Array creation dispatching with __array_function__
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="nep-0040-legacy-datatype-impl.html">
   NEP 40 — Legacy datatype implementation in NumPy
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="nep-0049.html">
   NEP 49 — Data allocation strategies
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="nep-0002-warnfix.html">
   NEP 2 — A proposal to build numpy without warning with a big set of warning flags
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="nep-0003-math_config_clean.html">
   NEP 3 — Cleaning the math configuration of numpy.core
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="nep-0004-datetime-proposal3.html">
   NEP 4 — A (third) proposal for implementing some date/time types in NumPy
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="nep-0006-newbugtracker.html">
   NEP 6 — Replacing Trac with a different bug tracker
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="nep-0008-groupby_additions.html">
   NEP 8 —  A proposal for adding groupby functionality to NumPy
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="nep-0009-structured_array_extensions.html">
   NEP 9 — Structured array extensions
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="nep-0011-deferred-ufunc-evaluation.html">
   NEP 11 — Deferred UFunc evaluation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="nep-0012-missing-data.html">
   NEP 12 — Missing data functionality in NumPy
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="nep-0024-missing-data-2.html">
   NEP 24 — Missing data functionality - Alternative 1 to NEP 12
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="nep-0025-missing-data-3.html">
   NEP 25 — NA support via special dtypes
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="nep-0026-missing-data-summary.html">
   NEP 26 — Summary of missing data NEPs and discussion
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="nep-0016-abstract-array.html">
   NEP 16 — An abstract base class for identifying "duck arrays"
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="nep-0017-split-out-maskedarray.html">
   NEP 17 — Split out masked arrays
  </a>
 </li>
</ul>

  </div>
</nav>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
              
              <div class="toc-item">
                
<div class="tocsection onthispage pt-5 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#abstract">
   Abstract
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#detailed-description">
   Detailed description
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#implementation">
   Implementation
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#backward-compatibility">
   Backward compatibility
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#alternatives">
   Alternatives
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#discussion">
   Discussion
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#references-and-footnotes">
   References and Footnotes
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#copyright">
   Copyright
  </a>
 </li>
</ul>

</nav>
              </div>
              
              <div class="toc-item">
                
              </div>
              
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <section id="nep-20-expansion-of-generalized-universal-function-signatures">
<span id="nep20"></span><h1>NEP 20 — Expansion of generalized universal function signatures<a class="headerlink" href="#nep-20-expansion-of-generalized-universal-function-signatures" title="Permalink to this headline">¶</a></h1>
<dl class="field-list simple">
<dt class="field-odd">Author</dt>
<dd class="field-odd"><p>Marten van Kerkwijk &lt;<a class="reference external" href="mailto:mhvk&#37;&#52;&#48;astro&#46;utoronto&#46;ca">mhvk<span>&#64;</span>astro<span>&#46;</span>utoronto<span>&#46;</span>ca</a>&gt;</p>
</dd>
<dt class="field-even">Status</dt>
<dd class="field-even"><p>Final</p>
</dd>
<dt class="field-odd">Type</dt>
<dd class="field-odd"><p>Standards Track</p>
</dd>
<dt class="field-even">Created</dt>
<dd class="field-even"><p>2018-06-10</p>
</dd>
<dt class="field-odd">Resolution</dt>
<dd class="field-odd"><p><a class="reference external" href="https://mail.python.org/pipermail/numpy-discussion/2018-April/077959.html">https://mail.python.org/pipermail/numpy-discussion/2018-April/077959.html</a>,
<a class="reference external" href="https://mail.python.org/pipermail/numpy-discussion/2018-May/078078.html">https://mail.python.org/pipermail/numpy-discussion/2018-May/078078.html</a></p>
</dd>
</dl>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The proposal to add fixed (i) and flexible (ii) dimensions
was accepted, while that to add broadcastable (iii) ones was deferred.</p>
</div>
<section id="abstract">
<h2>Abstract<a class="headerlink" href="#abstract" title="Permalink to this headline">¶</a></h2>
<p>Generalized universal functions are, as their name indicates, generalization
of universal functions: they operate on non-scalar elements.  Their signature
describes the structure of the elements they operate on, with names linking
dimensions of the operands that should be the same.  Here, it is proposed to
extend the signature to allow the signature to indicate that a dimension (i)
has fixed size; (ii) can be absent; and (iii) can be broadcast.</p>
</section>
<section id="detailed-description">
<h2>Detailed description<a class="headerlink" href="#detailed-description" title="Permalink to this headline">¶</a></h2>
<p>Each part of the proposal is driven by specific needs <a class="footnote-reference brackets" href="#id12" id="id1">1</a>.</p>
<ol class="arabic">
<li><p>Fixed-size dimensions.  Code working with spatial vectors often explicitly
is for 2 or 3-dimensional space (e.g., the code from the <a class="reference external" href="http://www.iausofa.org/">Standards Of
Fundamental Astronomy</a>, which the author hopes
to wrap using gufuncs for astropy <a class="footnote-reference brackets" href="#id13" id="id2">2</a>).  The signature should be able to
indicate that.  E.g., the signature of a function that converts a polar
angle to a two-dimensional cartesian unit vector would currently have to be
<code class="docutils literal notranslate"><span class="pre">()-&gt;(n)</span></code>, with there being no way to indicate that <code class="docutils literal notranslate"><span class="pre">n</span></code> has to equal 2.
Indeed, this signature is particularly annoying since without putting in an
output argument, the current gufunc wrapper code fails because it cannot
determine <code class="docutils literal notranslate"><span class="pre">n</span></code>.  Similarly, the signature for an cross product of two
3-dimensional vectors has to be <code class="docutils literal notranslate"><span class="pre">(n),(n)-&gt;(n)</span></code>, with again no way to
indicate that <code class="docutils literal notranslate"><span class="pre">n</span></code> has to equal 3.  Hence, the proposal here to allow one
to give numerical values in addition to variable names.  Thus, angle to
two-dimensional unit vector would be <code class="docutils literal notranslate"><span class="pre">()-&gt;(2)</span></code>; two angles to
three-dimensional unit vector <code class="docutils literal notranslate"><span class="pre">(),()-&gt;(3)</span></code>; and that for the cross
product of two three-dimensional vectors would be <code class="docutils literal notranslate"><span class="pre">(3),(3)-&gt;(3)</span></code>.</p></li>
<li><p>Possibly missing dimensions.  This part is almost entirely driven by the
wish to wrap <code class="docutils literal notranslate"><span class="pre">matmul</span></code> in a gufunc. <code class="docutils literal notranslate"><span class="pre">matmul</span></code> stands for matrix
multiplication, and if it did only that, it could be covered with the
signature <code class="docutils literal notranslate"><span class="pre">(m,n),(n,p)-&gt;(m,p)</span></code>. However, it has special cases for when a
dimension is missing, allowing either argument to be treated as a single
vector, with the function thus becoming, effectively, vector-matrix,
matrix-vector, or vector-vector multiplication (but with no
broadcasting). To support this, it is suggested to allow postfixing a
dimension name with a question mark to indicate that the dimension does not
necessarily have to be present.</p>
<p>With this addition, the signature for <code class="docutils literal notranslate"><span class="pre">matmul</span></code> can be expressed as
<code class="docutils literal notranslate"><span class="pre">(m?,n),(n,p?)-&gt;(m?,p?)</span></code>.  This indicates that if, e.g., the second
operand has only one dimension, for the purposes of the elementary function
it will be treated as if that input has core shape <code class="docutils literal notranslate"><span class="pre">(n,</span> <span class="pre">1)</span></code>, and the
output has the corresponding core shape of <code class="docutils literal notranslate"><span class="pre">(m,</span> <span class="pre">1)</span></code>. The actual output
array, however, has the flexible dimension removed, i.e., it will have
shape <code class="docutils literal notranslate"><span class="pre">(...,</span> <span class="pre">m)</span></code>.  Similarly, if both arguments have only a single
dimension, the inputs will be presented as having shapes <code class="docutils literal notranslate"><span class="pre">(1,</span> <span class="pre">n)</span></code> and
<code class="docutils literal notranslate"><span class="pre">(n,</span> <span class="pre">1)</span></code> to the elementary function, and the output as <code class="docutils literal notranslate"><span class="pre">(1,</span> <span class="pre">1)</span></code>, while
the actual output array returned will have shape <code class="docutils literal notranslate"><span class="pre">()</span></code>. In this way, the
signature allows one to use a single elementary function for four related
but different signatures, <code class="docutils literal notranslate"><span class="pre">(m,n),(n,p)-&gt;(m,p)</span></code>, <code class="docutils literal notranslate"><span class="pre">(n),(n,p)-&gt;(p)</span></code>,
<code class="docutils literal notranslate"><span class="pre">(m,n),(n)-&gt;(m)</span></code> and <code class="docutils literal notranslate"><span class="pre">(n),(n)-&gt;()</span></code>.</p>
</li>
<li><p>Dimensions that can be broadcast. For some applications, broadcasting
between operands makes sense. For instance, an <code class="docutils literal notranslate"><span class="pre">all_equal</span></code> function that
compares vectors in arrays could have a signature <code class="docutils literal notranslate"><span class="pre">(n),(n)-&gt;()</span></code>, but this
forces both operands to be arrays, while it would be useful also to check
that, e.g., all parts of a vector are constant (maybe zero). The proposal
is to allow the implementer of a gufunc to indicate that a dimension can be
broadcast by post-fixing the dimension name with <code class="docutils literal notranslate"><span class="pre">|1</span></code>. Hence, the
signature for <code class="docutils literal notranslate"><span class="pre">all_equal</span></code> would become <code class="docutils literal notranslate"><span class="pre">(n|1),(n|1)-&gt;()</span></code>.  The
signature seems handy more generally for “chained ufuncs”; e.g., another
application might be in a putative ufunc implementing <code class="docutils literal notranslate"><span class="pre">sumproduct</span></code>.</p>
<p>Another example that arose in the discussion, is of a weighted mean, which
might look like <code class="docutils literal notranslate"><span class="pre">weighted_mean(y,</span> <span class="pre">sigma[,</span> <span class="pre">axis,</span> <span class="pre">...])</span></code>, returning the
mean and its uncertainty.  With a signature of <code class="docutils literal notranslate"><span class="pre">(n),(n)-&gt;(),()</span></code>, one
would be forced to always give as many sigmas as there are data points,
while broadcasting would allow one to give a single sigma for all points
(which is still useful to calculate the uncertainty on the mean).</p>
</li>
</ol>
</section>
<section id="implementation">
<h2>Implementation<a class="headerlink" href="#implementation" title="Permalink to this headline">¶</a></h2>
<p>The proposed changes have all been implemented <a class="footnote-reference brackets" href="#id15" id="id3">3</a>, <a class="footnote-reference brackets" href="#id16" id="id4">4</a>, <a class="footnote-reference brackets" href="#id17" id="id5">5</a>. These PRs
extend the ufunc structure with two new fields, each of size equal to the
number of distinct dimensions, with <code class="docutils literal notranslate"><span class="pre">core_dim_sizes</span></code> holding possibly fixed
sizes, and <code class="docutils literal notranslate"><span class="pre">core_dim_flags</span></code> holding flags indicating whether a dimension can
be missing or broadcast.  To ensure we can distinguish between this new
version and previous versions, an unused entry <code class="docutils literal notranslate"><span class="pre">reserved1</span></code> is repurposed as
a version number.</p>
<p>In the implementation, care is taken that to the elementary function flagged
dimensions are not treated any differently than non-flagged ones: for
instance, sizes of fixed-size dimensions are still passed on to the elementary
function (but the loop can now count on that size being equal to the fixed one
given in the signature).</p>
<p>An implementation detail to be decided upon is whether it might be handy to
have a summary of all flags. This could possibly be stored in <code class="docutils literal notranslate"><span class="pre">core_enabled</span></code>
(which currently is a bool), with non-zero continuing to indicate a gufunc,
but specific flags indicating whether or not a gufunc uses fixed, flexible, or
broadcastable dimensions.</p>
<p>With the above, the formal definition of the syntax would become <a class="footnote-reference brackets" href="#id16" id="id6">4</a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">Signature</span><span class="o">&gt;</span>            <span class="p">:</span><span class="o">:=</span> <span class="o">&lt;</span><span class="n">Input</span> <span class="n">arguments</span><span class="o">&gt;</span> <span class="s2">&quot;-&gt;&quot;</span> <span class="o">&lt;</span><span class="n">Output</span> <span class="n">arguments</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">Input</span> <span class="n">arguments</span><span class="o">&gt;</span>      <span class="p">:</span><span class="o">:=</span> <span class="o">&lt;</span><span class="n">Argument</span> <span class="nb">list</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">Output</span> <span class="n">arguments</span><span class="o">&gt;</span>     <span class="p">:</span><span class="o">:=</span> <span class="o">&lt;</span><span class="n">Argument</span> <span class="nb">list</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">Argument</span> <span class="nb">list</span><span class="o">&gt;</span>        <span class="p">:</span><span class="o">:=</span> <span class="n">nil</span> <span class="o">|</span> <span class="o">&lt;</span><span class="n">Argument</span><span class="o">&gt;</span> <span class="o">|</span> <span class="o">&lt;</span><span class="n">Argument</span><span class="o">&gt;</span> <span class="s2">&quot;,&quot;</span> <span class="o">&lt;</span><span class="n">Argument</span> <span class="nb">list</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">Argument</span><span class="o">&gt;</span>             <span class="p">:</span><span class="o">:=</span> <span class="s2">&quot;(&quot;</span> <span class="o">&lt;</span><span class="n">Core</span> <span class="n">dimension</span> <span class="nb">list</span><span class="o">&gt;</span> <span class="s2">&quot;)&quot;</span>
<span class="o">&lt;</span><span class="n">Core</span> <span class="n">dimension</span> <span class="nb">list</span><span class="o">&gt;</span>  <span class="p">:</span><span class="o">:=</span> <span class="n">nil</span> <span class="o">|</span> <span class="o">&lt;</span><span class="n">Core</span> <span class="n">dimension</span><span class="o">&gt;</span> <span class="o">|</span>
                           <span class="o">&lt;</span><span class="n">Core</span> <span class="n">dimension</span><span class="o">&gt;</span> <span class="s2">&quot;,&quot;</span> <span class="o">&lt;</span><span class="n">Core</span> <span class="n">dimension</span> <span class="nb">list</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">Core</span> <span class="n">dimension</span><span class="o">&gt;</span>       <span class="p">:</span><span class="o">:=</span> <span class="o">&lt;</span><span class="n">Dimension</span> <span class="n">name</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">Dimension</span> <span class="n">modifier</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">Dimension</span> <span class="n">name</span><span class="o">&gt;</span>       <span class="p">:</span><span class="o">:=</span> <span class="n">valid</span> <span class="n">Python</span> <span class="n">variable</span> <span class="n">name</span> <span class="o">|</span> <span class="n">valid</span> <span class="n">integer</span>
<span class="o">&lt;</span><span class="n">Dimension</span> <span class="n">modifier</span><span class="o">&gt;</span>   <span class="p">:</span><span class="o">:=</span> <span class="n">nil</span> <span class="o">|</span> <span class="s2">&quot;|1&quot;</span> <span class="o">|</span> <span class="s2">&quot;?&quot;</span>
</pre></div>
</div>
<ol class="arabic simple">
<li><p>All quotes are for clarity.</p></li>
<li><p>Unmodified core dimensions that share the same name must have the same size.
Each dimension name typically corresponds to one level of looping in the
elementary function’s implementation.</p></li>
<li><p>White spaces are ignored.</p></li>
<li><p>An integer as a dimension name freezes that dimension to the value.</p></li>
<li><p>If a name if suffixed with the <code class="docutils literal notranslate"><span class="pre">|1</span></code> modifier, it is allowed to broadcast
against other dimensions with the same name.  All input dimensions
must share this modifier, while no output dimensions should have it.</p></li>
<li><p>If the name is suffixed with the <code class="docutils literal notranslate"><span class="pre">?</span></code> modifier, the dimension is a core
dimension only if it exists on all inputs and outputs that share it;
otherwise it is ignored (and replaced by a dimension of size 1 for the
elementary function).</p></li>
</ol>
<p>Examples of signatures <a class="footnote-reference brackets" href="#id16" id="id7">4</a>:</p>
<table class="table">
<colgroup>
<col style="width: 44%" />
<col style="width: 56%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p>Signature</p></td>
<td><p>Possible use</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">(),()-&gt;()</span></code></p></td>
<td><p>Addition</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">(i)-&gt;()</span></code></p></td>
<td><p>Sum over last axis</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">(i|1),(i|1)-&gt;()</span></code></p></td>
<td><p>Test for equality along axis,
allowing comparison with a scalar</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">(i),(i)-&gt;()</span></code></p></td>
<td><p>inner vector product</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">(m,n),(n,p)-&gt;(m,p)</span></code></p></td>
<td><p>matrix multiplication</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">(n),(n,p)-&gt;(p)</span></code></p></td>
<td><p>vector-matrix multiplication</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">(m,n),(n)-&gt;(m)</span></code></p></td>
<td><p>matrix-vector multiplication</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">(m?,n),(n,p?)-&gt;(m?,p?)</span></code></p></td>
<td><p>all four of the above at once,
except vectors cannot have loop
dimensions (ie, like <code class="docutils literal notranslate"><span class="pre">matmul</span></code>)</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">(3),(3)-&gt;(3)</span></code></p></td>
<td><p>cross product for 3-vectors</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">(i,t),(j,t)-&gt;(i,j)</span></code></p></td>
<td><p>inner over the last dimension,
outer over the second to last,
and loop/broadcast over the rest.</p></td>
</tr>
</tbody>
</table>
</section>
<section id="backward-compatibility">
<h2>Backward compatibility<a class="headerlink" href="#backward-compatibility" title="Permalink to this headline">¶</a></h2>
<p>One possible worry is the change in ufunc structure.  For most applications,
which call <code class="docutils literal notranslate"><span class="pre">PyUFunc_FromDataAndSignature</span></code>, this is entirely transparent.
Furthermore, by repurposing <code class="docutils literal notranslate"><span class="pre">reserved1</span></code> as a version number, code compiled
against older versions of numpy will continue to work (though one will get a
warning upon import of that code with a newer version of numpy), except if
code explicitly changes the <code class="docutils literal notranslate"><span class="pre">reserved1</span></code> entry.</p>
</section>
<section id="alternatives">
<h2>Alternatives<a class="headerlink" href="#alternatives" title="Permalink to this headline">¶</a></h2>
<p>It was suggested instead of extending the signature, to have multiple
dispatch, so that, e.g., <code class="docutils literal notranslate"><span class="pre">matmul</span></code> would simply have the multiple signatures
it supports, i.e., instead of <code class="docutils literal notranslate"><span class="pre">(m?,n),(n,p?)-&gt;(m?,p?)</span></code> one would have
<code class="docutils literal notranslate"><span class="pre">(m,n),(n,p)-&gt;(m,p)</span> <span class="pre">|</span> <span class="pre">(n),(n,p)-&gt;(p)</span> <span class="pre">|</span> <span class="pre">(m,n),(n)-&gt;(m)</span> <span class="pre">|</span> <span class="pre">(n),(n)-&gt;()</span></code>.  A
disadvantage of this is that the developer now has to make sure that the
elementary function can deal with these different signatures.  Furthermore,
the expansion quickly becomes cumbersome.  For instance, for the <code class="docutils literal notranslate"><span class="pre">all_equal</span></code>
signature of <code class="docutils literal notranslate"><span class="pre">(n|1),(n|1)-&gt;()</span></code>, one would have to have five entries:
<code class="docutils literal notranslate"><span class="pre">(n),(n)-&gt;()</span> <span class="pre">|</span> <span class="pre">(n),(1)-&gt;()</span> <span class="pre">|</span> <span class="pre">(1),(n)-&gt;()</span> <span class="pre">|</span> <span class="pre">(n),()-&gt;()</span> <span class="pre">|</span> <span class="pre">(),(n)-&gt;()</span></code>.  For
signatures like <code class="docutils literal notranslate"><span class="pre">(m|1,n|1,o|1),(m|1,n|1,o|1)-&gt;()</span></code> (from the <code class="docutils literal notranslate"><span class="pre">cube_equal</span></code>
test case in <a class="footnote-reference brackets" href="#id16" id="id8">4</a>), it is not even worth writing out the expansion.</p>
<p>For broadcasting, the alternative suffix of <code class="docutils literal notranslate"><span class="pre">^</span></code> was suggested (as
broadcasting can be thought of as increasing the size of the array).  This
seems less clear.  Furthermore, it was wondered whether it should not just be
an all-or-nothing flag.  This could be the case, though given the postfix
for flexible dimensions, arguably another postfix is clearer (as is the
implementation).</p>
</section>
<section id="discussion">
<h2>Discussion<a class="headerlink" href="#discussion" title="Permalink to this headline">¶</a></h2>
<p>The proposals here were discussed at fair length on the mailing list <a class="footnote-reference brackets" href="#id18" id="id9">6</a>,
<a class="footnote-reference brackets" href="#id19" id="id10">7</a>.  The main points of contention were whether the use cases were
sufficiently strong. In particular, for frozen dimensions, it was argued that
checks on the right number could be put in loop selection code.  This seems
much less clear for no benefit.</p>
<p>For broadcasting, the lack of examples of elementary functions that might need
it was noted, with it being questioned whether something like <code class="docutils literal notranslate"><span class="pre">all_equal</span></code>
was best done with a gufunc rather than as a special method on <code class="docutils literal notranslate"><span class="pre">np.equal</span></code>.
One counter-argument to this would be that there is an actual PR for
<code class="docutils literal notranslate"><span class="pre">all_equal</span></code> <a class="footnote-reference brackets" href="#id20" id="id11">8</a>.  Another that even if one were to use a method, it would
be good to be able to express their signature (just as is possible at least
for <code class="docutils literal notranslate"><span class="pre">reduce</span></code> and <code class="docutils literal notranslate"><span class="pre">accumulate</span></code>).</p>
<p>A final argument was that we were making the gufuncs too complex. This
arguably holds for the dimensions that can be omitted, but that also has the
strongest use case. The frozen dimensions has a very simple implementation and
its meaning is obvious. The ability to broadcast is simple too, once the
flexible dimensions are supported.</p>
</section>
<section id="references-and-footnotes">
<h2>References and Footnotes<a class="headerlink" href="#references-and-footnotes" title="Permalink to this headline">¶</a></h2>
<dl class="footnote brackets">
<dt class="label" id="id12"><span class="brackets"><a class="fn-backref" href="#id1">1</a></span></dt>
<dd><p>Identified needs and suggestions for the implementation are not all by
the author. In particular, the suggestion for fixed dimensions and
initial implementation was by Jaime Frio (<a class="reference external" href="https://github.com/numpy/numpy/pull/5015">gh-5015</a>), the suggestion of <code class="docutils literal notranslate"><span class="pre">?</span></code>
to indicate dimensions can be omitted was by Nathaniel Smith, and the
initial implementation of that by Matti Picus (<a class="reference external" href="https://github.com/numpy/numpy/pull/11132">gh-11132</a>).</p>
</dd>
<dt class="label" id="id13"><span class="brackets"><a class="fn-backref" href="#id2">2</a></span></dt>
<dd><p><a class="reference external" href="https://github.com/astropy/astropy/pull/7502">wrap ERFA functions in gufuncs</a> (<a class="reference external" href="https://github.com/liberfa/erfa">ERFA</a>) is the less stringently licensed
version of <a class="reference external" href="http://www.iausofa.org/">Standards Of Fundamental Astronomy</a></p>
</dd>
<dt class="label" id="id15"><span class="brackets"><a class="fn-backref" href="#id3">3</a></span></dt>
<dd><p><a class="reference external" href="https://github.com/numpy/numpy/pull/11175">fixed-size and flexible dimensions</a></p>
</dd>
<dt class="label" id="id16"><span class="brackets">4</span><span class="fn-backref">(<a href="#id4">1</a>,<a href="#id6">2</a>,<a href="#id7">3</a>,<a href="#id8">4</a>)</span></dt>
<dd><p><a class="reference external" href="https://github.com/numpy/numpy/pull/11179">broadcastable dimensions</a></p>
</dd>
<dt class="label" id="id17"><span class="brackets"><a class="fn-backref" href="#id5">5</a></span></dt>
<dd><p><a class="reference external" href="https://github.com/numpy/numpy/pull/11133">use in matmul</a></p>
</dd>
<dt class="label" id="id18"><span class="brackets"><a class="fn-backref" href="#id9">6</a></span></dt>
<dd><p>Discusses implementations for <code class="docutils literal notranslate"><span class="pre">matmul</span></code>:
<a class="reference external" href="https://mail.python.org/pipermail/numpy-discussion/2018-May/077972.html">https://mail.python.org/pipermail/numpy-discussion/2018-May/077972.html</a>,
<a class="reference external" href="https://mail.python.org/pipermail/numpy-discussion/2018-May/078021.html">https://mail.python.org/pipermail/numpy-discussion/2018-May/078021.html</a></p>
</dd>
<dt class="label" id="id19"><span class="brackets"><a class="fn-backref" href="#id10">7</a></span></dt>
<dd><p>Broadcasting:
<a class="reference external" href="https://mail.python.org/pipermail/numpy-discussion/2018-May/078078.html">https://mail.python.org/pipermail/numpy-discussion/2018-May/078078.html</a></p>
</dd>
<dt class="label" id="id20"><span class="brackets"><a class="fn-backref" href="#id11">8</a></span></dt>
<dd><p><a class="reference external" href="https://github.com/numpy/numpy/pull/8528">Logical gufuncs</a> (includes
<code class="docutils literal notranslate"><span class="pre">all_equal</span></code>)</p>
</dd>
</dl>
</section>
<section id="copyright">
<h2>Copyright<a class="headerlink" href="#copyright" title="Permalink to this headline">¶</a></h2>
<p>This document has been placed in the public domain.</p>
</section>
</section>


              </div>
              
              
          </main>
          

      </div>
    </div>
  
  <script src="_static/js/index.be7d3bbb2ef33a8344ce.js"></script>
<footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2017-2018, NumPy Developers.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.2.0.<br>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>